COMPREHENSIVE DEVELOPMENT SPECIFICATION: DSSA PMPro PLUGINS
================================================================================

PROJECT OVERVIEW & CONTEXT
================================================================================

The Dendrological Society of South Africa (DSSA) requires a membership management system built on WordPress and Paid Memberships Pro (PMPro). This system must handle both legacy members (currently managed offline) and new members, with specific billing logic, registration workflows, and administrative controls. The project consists of a plugin that extends PMPro functionality. Client: Dendrological Society of South Africa (DSSA) Language Requirements: All public-facing text must use South African English unless specified otherwise. Code comments and internal documentation should use clear English, but variable/function names follow standard programming conventions. Payment Gateway: Paystack (African payment processor) Legacy Data: Existing members to be migrated via CSV upload (their membership numbers, then they're invited to register). Prioritize accurate, secure, and compliant implementations (e.g., POPIA for member data). Where text is shown in English and Afrikaans as such: English Text / Afrikaanse Teks - it should be given as such, not through localisation or translation of any kind.

TECHNICAL STANDARDS & REQUIREMENTS
================================================================================

DEVELOPMENT STANDARDS
---------------------
1. WordPress Best Practices: Follow WordPress Coding Standards, use appropriate hooks (actions/filters), and maintain compatibility with WordPress 6.0+ and PHP 8.0+
2. Security: Implement nonces, capability checks, data sanitization/validation, prepared database statements, and secure file upload handling
3. Performance: Optimize database queries, implement caching where appropriate, minimize external dependencies
4. Maintainability: Well-commented code, organized file structure, use of WordPress transient API for temporary data
5. Compatibility: Must work with PMPro 2.9+ and remain functional through future WordPress/PHP updates
6. Error Handling: Comprehensive logging via WordPress debug functions with admin notifications for critical errors

PLUGIN: DSSA PMPro Helper
================================================================================

1. CORE FUNCTIONALITY
---------------------

1.1 REGISTRATION FORM MODIFICATIONS
Location: PMPro checkout page (/member-checkout/)

	Native Field Label Changes (using PMPro filters):
	- Username -> Username / Gebruikersnaam
	- Email -> Email / E-pos
	- Confirm Email -> Confirm Email / Bevestig E-pos
	- Password -> Password / Wagwoord
	- Confirm Password -> Confirm Password / Bevestig Wagwoord

	Implementation Note: Use pmpro_checkout_boxes filter to reorder fields so First/Last Name appear with other account fields.

1.2 CUSTOM REGISTRATION FIELDS
The following fields I have already created under User Fields (PMPro's custom fields that users can create).

	FIELD 1: Existing Member / Bestaande Lid
	- Field Name: exist_member
	- Type: Checkbox
	- Description:
	  Select only if you are an existing DSSA member, not yet registered on the website. / Kies slegs as jy 'n bestaande DSSA-lid is wat nog nie op die webblad geregistreer is nie.

	FIELD 2: Membership Number / Lidmaatskapnommer
	- Visibility: Conditional upon exist_member checkbox being selected
	- Field Name: member_number
	- Type: Text
	- Description:
	  Enter your membership number / Verskaf jou lidmaatskapnommer
	- Validation: If selected, must be an unclaimed number from the legacy database
	
	FIELD 3: Branch / Tak
	- Field Name: branch
	- Type: Checkbox
	- Description:
	  Select the branch you are assigned to. / Kies die tak waaraan jy toegedeel is. 

	FIELD 4: Card Payments / Kaart-betalings
	- Field Name: card_payments
	- Type: Checkbox
	- Description:
	  Select only if you wish for us to debit your credit or debit card. If left unselected, you will be requested to make payment from your bank via EFT. / Kies slegs indien jy verkies dat ons jou krediet- of debietkaart moet debiteer. Indien nie, sal jy versoek word om betaling te doen vanaf jou bank per EFT.
	  
	Please "hack" these fields to change their visibility as follows:
	
	In Checkout:
	- FIELD 2 and FIELD 3 should initially be hidden, and be conditionally shown only if FIELD 1 is selected.
	- FIELD 4 should initially be visible, but be hidden if FIELD 1 is selected.
	
	In Profile: The selection and field visibility should work the same way as in Checkout, but the then-currently visible fields should be locked (read-only) for the member. Only Membership Manager or Admin should be able to edit the fields.
  
1.3 MEMBERSHIP LEVEL ASSIGNMENT LOGIC
Four Membership Levels (PMPro levels 1-4):
	1. Level 1: Individual/Family (Under 70) - R300/year
	2. Level 2: Individual/Family 70+ - R100/year
	3. Level 3: Students - R90/year
	4. Level 4: Organisations - R500/year

1.4 LEGACY MEMBER REGISTRATION FLOW
Legacy members are current DSSA members that are not yet registered on the website. Their membership payments are not managed via PMPro, and will remain offline for now.
	1. CSV Upload: Admin uploads legacy-members.csv with one column: membership_number
	2. Database Storage: Numbers stored in wp_dssa_legacy_numbers with status:
	   unclaimed, claimed
	3. Registration Process:
		- Legacy member enters their number in Membership Number free-text field
		- System verifies number exists and unclaimed/claimed via Ajax
		- If number exists but is claimed, or does not exist, display relevant error message in red
		- If number exists and is available, display green confirmation message
		- Payment section skipped altogether - Legacy Members pay offline.
		- Membership level and membership benefits assigned immediately
		- membership_number saved to user meta
		- Legacy membership number status updated to claimed
   
1.5 NEW MEMBER REGISTRATION FLOW
	1. Registration Process:
		- New member selects Card Payments checkbox or leaves it blank
		- If member selects Card Payments checkbox, move to point 2 below
		- If member does not select Card Payments checkbox, move to point 3 below
	2. Payment Calculation:
		- Calculate pro-rata amount based on days remaining in membership year
		- Formula: (annual_fee / 12) × months_remaining
		- In accordance with DSSA constitution, Paystack transaction fees have to be passed on to members:
			- Paystack fees are 2.9% + ZAR 1
			- Calculate amount added to member's payment so that DSSA receives exact amount (R300, R100, R90 or R500 in accordance with membership selection) after deduction of Paystack transaction fee.
		- If ≤14 days remain before next renewal date: no pro-rata payment, e.g. charge = 0
	3. Post-Registration:
		- User receives "Pending Activation" notice on confirmation page
		- Membership Manager (role: membership_manager) receives notification of new member registration, request to assign membership number and branch
		- Membership benefits disabled until Membership Manager approval
			
2. CUSTOM PMPRO BILLING
-----------------------

2.1 PAYSTACK FEE CALCULATIONS
Configuration: Admin sets fees in DSSA Admin panel:
	- Percentage [2.9] + Fixed amount [1.00]

Calculation Logic:
	To ensure DSSA receives exact membership fee after Paystack deductions:

	Let M = membership fee (Rands)
	Let p = Paystack percentage (as decimal, e.g., 0.029)
	Let f = Paystack fixed fee (e.g., 1.00)

	We need to find T (total to charge customer) such that:
	T - (T * p + f) = M

	Solving for T:
	T = (M + f) / (1 - p)

Implementation:
	- Hook into pmpro_checkout_level to modify level price
	- Apply to initial signup and renewal payments
	- Detect country from billing address or IP for local/international rate

2.2 PRO-RATA BILLING ENGINE
Annual Renewal Date: Configurable day/month (e.g., 1 March) via admin

Calculation Scenarios:

	SCENARIO A: NEW MEMBER WITH >14 DAYS REMAINING
	Join date: 15 January 2024
	Renewal date: 1 March annually
	Months remaining in cycle: 2 (January & February)
	Annual fee: R300
	Pro-rata: (300 / 12) × 2 = R50.00
	Total with Paystack fees: Calculate T as above

	SCENARIO B: NEW MEMBER WITH ≤14 DAYS REMAINING
	Join date: 20 February 2024
	Renewal date: 1 March annually
	Days remaining: 10 days (≤14 threshold)
	Charge: R0, no payment deferred

	SCENARIO C: LEGACY MEMBER
	No charge, skip payment stage altogether

2.3 RENEWAL SYSTEM
Annual Renewals:
	- Cron job runs daily to check for renewals
	- Process renewals 3 days before due date
	- Apply Paystack fee calculations to renewal amounts

Failed Renewals:
	- 3 retry attempts over 7 days
	- Email notifications to member and admin
	- Grace period of 60 days before access restriction

Renewal Reminders:
	- Configurable days before renewal (default: 14)
	- Email templates with South African English
	- Include payment link and amount due
	- Test email functionality in admin
	
3. CUSTOM PMPRO LOGIN
---------------------

3.1 CUSTOM LOGIN SYSTEM
Shortcode: [custom_pmpro_login_form]
	- Creates login form styled to match PMPro checkout
	- Field: "Membership Number" (not username/email)
	- Password field with show/hide toggle (eye icon)
	- "Remember Me" checkbox
	- Links: 
	  * "Forgot your password?" - links to /reset-password/
	  * "Register" - links to PMPro checkout page

Authentication Hook:
	- Filter authenticate to check membership number
	- Map membership number to user ID via user meta
	- Fallback: Also allow email login for admins

Redirect Logic:
	- Successful login → redirect to /members-area/
	- Failed login → show error on same page
	- Logout → redirect to homepage

3.2 CUSTOM PASSWORD RESET SYSTEM (NEW)

Password Reset Flow:
	1. Login Page (/members-login/): "Forgot your password?" link redirects to /reset-password/
	2. Reset Page (/reset-password/): Displays form via [custom_pmpro_reset_password] shortcode
	3. Form Fields:
	   - Field label: "Membership Number or Email Address / Lidnommer of E-posadres"
	   - Input type: Text field with placeholder: "Enter your membership number or email"
	   - Submit button: "Reset Password/Herstel Wagwoord"
	4. Processing Logic:
	   - Accepts either membership number or email
	   - If membership number: Look up user via membership_number user meta
	   - If email: Use standard WordPress email lookup
	   - Trigger standard PMPro/WordPress password reset email
	   - AJAX submission with inline success/error messages
	5. Security Measures:
	   - Rate limiting: Max 3 attempts per hour per IP
	   - Log reset attempts to audit log (wp_dssa_audit_log)
	   - WordPress nonces for form submission
	6. Integration:
	   - Uses WordPress retrieve_password and reset_password functions
	   - Custom email template for South African English reset emails
	   - Reset link expires in 24 hours (WordPress default)

Implementation:
	- Shortcode: [custom_pmpro_reset_password]
	- Template: templates/reset-password-form.php
	- AJAX handler in class-password-reset.php
	- Hook into WordPress password reset flow with custom validation

3.3 DASHBOARD ACCESS CONTROL

Allowed Roles for /wp-admin/:
	- Administrator
	- membership_manager (custom role)

Restriction Logic:
	- Hook into init to check if user is trying to access admin
	- If user has PMPro membership but not allowed role:
	  - Redirect to /members-login/
	  - Show message: "Please use the [Members Login page](/members-login/) to sign in."
	  - Do not proceed with WordPress login

Membership Manager Role:
	- Clone of Editor role
	- Add capabilities: manage_dssa, view_dssa_reports
	- Remove capabilities: edit_theme_options, manage_options
	
4. ADMIN
--------

4.1 DSSA ADMIN INTERFACE

Menu Structure (top level, directly below 'Memberships' in left menu):
	DSSA Admin (icon: dashicons-calendar)
		├── Dashboard
		├── Legacy Members
		├── Branch Management
		├── Billing Settings
		├── Member Management
		└── Reports

	SECTION 1: LEGACY MEMBER MANAGEMENT
		- CSV upload with AJAX progress indicator
		- File validation: .csv format, required columns
		- Processing: Parse CSV, validate data, insert to database
		- Interactive table with search, filter by status
		- Manual controls: Mark as claimed/unclaimed, delete entries
		- Export functionality: Current list as CSV

	SECTION 2: BRANCH MANAGEMENT
		- Branches are managed via Select / Dropdown User Field (Name: branch) already created under User Fields - no CSV upload
		- Membership Manager allocates new (non-Legacy) members to a branch and checks that Legacy member selected a branch

	SECTION 3: BILLING SETTINGS
		- Renewal date picker: Month dropdown (1-12), Day dropdown (1-31, dynamic based on month)
		- JavaScript validation for valid dates (leap year aware)
		- Display: "Next renewal date: 1 March 2025"
		- Paystack fee configuration
		- Test fee calculation tool: Enter amount, see breakdown

	SECTION 4: MEMBER MANAGEMENT
		- Enhanced user list with DSSA columns: Membership Number, Branch, Status
		- Quick edit functions: Assign number, change branch, reset password
		- Bulk actions: Export selected, send welcome email, update branches

	SECTION 5: REPORTS
		- Membership statistics: Total, by level, by branch
		- Renewal projections: Upcoming renewals next 30/60/90 days
		- Financial reports: Collected fees, pending renewals
		- Export all data to CSV/PDF

4.2 SECURITY & DATA MANAGEMENT

Data Storage:
	- Custom tables for legacy numbers and branches
	- Use $wpdb->prefix for table names
	- Database versioning for updates

Backup/Export:
	- Daily automated backup of DSSA data
	- One-click export of all member data (POPIA compliant)
	- Audit log: Track admin actions (who changed what and when)

POPIA Compliance:
	- Data retention settings (auto-delete after X years)
	- Anonymize function for deleted members
	- Privacy policy integration
	- Right to export/delete data tools

SUGGESTED FILE STRUCTURE FOR PLUGIN
------------------------------------
Please suggest.

Key Observations & Clarifications Needed:
1. Payment Flow Clarification
For new members who don't select "Card Payments": The spec says they'll be asked to pay via EFT. Does this mean:
	They should receive an invoice with banking details?
		My answer: No, their payments will be managed completely offile, similar to that of legacy members. They will, unlike legacy members, not be given membership privileges right away.
	Their account should be in a "pending payment" state?
		My answer: Yes, and, along with new (non-legacy) members who do select "Card Payments," they also have to be assigned a membership number and branch by the Membership Manager. Only threafter, provided their payment was received, the Membership Manager will activate their membership. But recording their payment and activating their membership is all done by the Membership Manager and not our system.
	Should there be an option for admin to manually mark EFT payments as received?
		My answer: No, EFT payments should not even feature in our system. That might be something for the future.
2. Legacy Member Workflow Nuance
When legacy members register with their number, they get immediate access without payment. Should they:
	Receive a welcome email confirming their legacy status?
		My answer: Yes, but they shouldn't be called "Legacy Member." Rather use the name of the membership.
	Have their membership expire date set (if they have one in legacy system)?
		My answer: No, not needed.
	Be prompted to update payment method for future renewals?
		My answer: No. Their billing happens completely offline.
3. Branch Field Implementation
The spec mentions branches are managed via a dropdown user field. Should this be:
	A fixed list managed by admin in the DSSA Admin interface?
		My answer: This is a User Field already created under User Fields in Paid Memberships Pro > Memberships > Settings > User Fields. The field name is branch (Label: Branch / Tak). It's a dropdown field already populated with the names of the branches.
	Editable only by admin/membership_manager?
		My answer: Access to the entire "Memberships" menu and editing of members, settings etc. is already limited to Admin and Membership Manager by another plugin.
	Should branch assignment affect any other functionality?
		My answer: No need.
4. Membership Number Generation
	For new members (non-legacy), who assigns membership numbers and when?
		My answer: DSSA administration, specifically the Membership Manager, assigns membership numbers before activating membership privileges.
	Automatically generated sequential numbers?
		My answer: No, they have their own offline membership number generation system.
	Assigned by Membership Manager during approval?
		My answer: Yes.
	Should there be a prefix (e.g., "DSSA-2024-")?
		My answer: No need to worry about this, it doesn't concern us. It happens offline.
5. Renewal Date Configuration
The annual renewal date is configurable (e.g., 1 March). Should this apply to:
	All members uniformly?
		My answer: Yes
	Or pro-rate to this date regardless of signup date?
		My answer: Yes
	What about legacy members with different renewal dates?
		My answer: Doesn't affect them, they are billed offline (and so are non-legacy memebrs who elected no to pay by card).
6. Paystack Integration Depth
Will you need:
	Direct Paystack API integration for recurring charges?
		My answer: Already integrated in PMPro
	Or just the fee calculation for one-time payments?
		My answer: No, members who opted for card payments will be subjected to recurring charges.
	Should failed Paystack payments trigger the retry system?
		My answer: Yes.
		
Questions Before We Start Coding:

	1. Priority Order: Which functionality should we build first? I suggest:
		1. Custom fields with conditional logic
		2. Legacy member registration flow
		3. Admin interface basics
		4. Billing calculations
		5. Login/password reset system
		My answer: Let's start with points 1.1 - 1.4.

	2. Testing Environment: Do you have a staging site for testing? This plugin will need thorough testing with PMPro.
		My answer: Yes, all good. Staging site is situated at https://new.dendro.co.za, and is password-protected.
	3. Existing Custom Fields: You mentioned creating fields in PMPro's User Fields. Should we:
		- Use those existing fields?
		- Or create our own field management to ensure full control?
		My answer: It would be better to create our own field management, I think, to reduce the possibility they might be accidentally deleted or edited under PMPro settings.

	4. Error Handling Preference: How detailed should error messages be for users?
		- Generic messages for security?
		- Specific messages for debugging during development?
		My answer: Find a happy medium?

	5. Backward Compatibility: Should we maintain any compatibility with:
		- Other PMPro addons?
			My answer: 
			- Paid Memberships Pro - Roles Add On
			- Paid Memberships Pro - Update Manage
			- Paystack Gateway for Paid Memberships Pro
		- Specific themes?
			My answer: 
			- Divi Theme
		- Caching plugins?
			My answer: 
			- WP Compress